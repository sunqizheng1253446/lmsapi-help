<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NewAPI 令牌余额查询</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- 配置Tailwind自定义颜色和字体 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        danger: '#EF4444',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.1), 0 8px 10px -6px rgba(59, 130, 246, 0.1);
            }
            .btn-hover {
                @apply transition-all duration-300 hover:shadow-lg transform hover:-translate-y-0.5;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-light to-blue-50 min-h-screen font-inter text-dark flex flex-col">
    <!-- 顶部导航 -->
    <header class="bg-white/80 backdrop-blur-md shadow-sm sticky top-0 z-10">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-key text-primary text-2xl"></i>
                <h1 class="text-xl md:text-2xl font-bold text-primary">NewAPI 工具</h1>
            </div>
            <div class="text-sm text-gray-600">
                <span class="hidden md:inline">令牌余额查询器</span>
            </div>
        </div>
    </header>

    <!-- 主要内容 -->
    <main class="flex-grow container mx-auto px-4 py-8 md:py-16 flex flex-col items-center justify-center">
        <div class="w-full max-w-md">
            <!-- 卡片容器 -->
            <div class="bg-white rounded-2xl card-shadow p-6 md:p-8 mb-6 transform transition-all duration-500 hover:shadow-xl">
                <div class="text-center mb-6">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-primary/10 text-primary mb-4">
                        <i class="fa fa-balance-scale text-2xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold mb-2">令牌余额查询</h2>
                    <p class="text-gray-500 text-sm">输入您的NewAPI令牌以查询余额信息</p>
                </div>
                
                <!-- 表单 -->
                <form id="balanceForm" class="space-y-5">
                    <div>
                        <label for="token" class="block text-sm font-medium text-gray-700 mb-1">令牌 (Token)</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fa fa-key text-gray-400"></i>
                            </div>
                            <input 
                                type="text" 
                                id="token" 
                                name="token" 
                                required
                                placeholder="请输入您的令牌"
                                class="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all duration-200"
                            >
                        </div>
                        <p class="mt-1 text-xs text-gray-500">令牌是您访问API的重要凭证，请妥善保管</p>
                    </div>
                    

                    
                    <button 
                        type="submit" 
                        id="checkButton"
                        class="w-full bg-primary text-white py-3 px-4 rounded-lg font-medium btn-hover flex items-center justify-center"
                    >
                        <span>查询余额</span>
                        <i class="fa fa-arrow-right ml-2"></i>
                    </button>
                </form>
            </div>
            
            <!-- 结果显示区域 -->
            <div id="resultArea" class="hidden bg-white rounded-2xl card-shadow p-6 transition-all duration-500">
                <div id="loadingState" class="hidden text-center py-6">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-primary border-t-transparent mb-3"></div>
                    <p class="text-gray-600">正在查询余额...</p>
                </div>
                
                <div id="successState" class="hidden">
                    <div class="flex items-center justify-between mb-4 pb-4 border-b border-gray-100">
                        <h3 class="font-semibold text-lg">查询结果</h3>
                        <span id="resultTimestamp" class="text-xs text-gray-500"></span>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <p class="text-sm text-gray-500 mb-1">令牌状态</p>
                            <p id="tokenStatus" class="font-medium"></p>
                        </div>
                        
                        <div>
                            <p class="text-sm text-gray-500 mb-1">余额信息</p>
                            <p id="balanceValue" class="text-2xl font-bold text-primary"></p>
                        </div>
                        
                        <div id="pendingAmountContainer" class="hidden">
                            <p class="text-sm text-gray-500 mb-1">待入账金额</p>
                            <p id="pendingAmount" class="text-sm text-gray-600"></p>
                        </div>
                    </div>
                </div>
                
                <div id="errorState" class="hidden text-center py-6">
                    <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-danger/10 text-danger mb-4">
                        <i class="fa fa-exclamation-triangle"></i>
                    </div>
                    <h3 class="font-medium mb-2">查询失败</h3>
                    <p id="errorMessage" class="text-sm text-gray-600"></p>
                </div>
                
                <div class="mt-6 text-center">
                    <button 
                        id="resetButton"
                        class="text-primary hover:text-primary/80 text-sm font-medium transition-colors"
                    >
                        <i class="fa fa-refresh mr-1"></i> 重新查询
                    </button>
                </div>
            </div>
            
            <!-- 信息提示 -->
            <div class="bg-blue-50 border-l-4 border-primary p-4 rounded-r-lg text-sm text-gray-700">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fa fa-info-circle text-primary"></i>
                    </div>
                    <div class="ml-3">
                        <p>接口说明：查询结果基于NewAPI的https://api.kaka11.top/v1/dashboard/billing/subscription接口。</p>
                        <p class="mt-1">若令牌为无限额度，将显示-1。</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-white py-6 border-t border-gray-200">
        <div class="container mx-auto px-4 text-center text-sm text-gray-500">
            <p>© 2023 NewAPI 令牌余额查询工具</p>
            <p class="mt-1">本工具仅用于查询令牌余额，不存储任何用户信息</p>
        </div>
    </footer>

    <script>
        // 获取DOM元素
        const balanceForm = document.getElementById('balanceForm');
        const tokenInput = document.getElementById('token');
        const checkButton = document.getElementById('checkButton');
        const resultArea = document.getElementById('resultArea');
        const loadingState = document.getElementById('loadingState');
        const successState = document.getElementById('successState');
        const errorState = document.getElementById('errorState');
        const tokenStatus = document.getElementById('tokenStatus');
        const balanceValue = document.getElementById('balanceValue');
        const pendingAmountContainer = document.getElementById('pendingAmountContainer');
        const pendingAmount = document.getElementById('pendingAmount');
        const resultTimestamp = document.getElementById('resultTimestamp');
        const errorMessage = document.getElementById('errorMessage');
        const resetButton = document.getElementById('resetButton');

        // 表单提交处理
        balanceForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const token = tokenInput.value.trim();
            
            if (!token) {
                alert('请输入令牌信息');
                return;
            }
            
            // 显示结果区域和加载状态
            resultArea.classList.remove('hidden');
            loadingState.classList.remove('hidden');
            successState.classList.add('hidden');
            errorState.classList.add('hidden');
            
            // 禁用按钮防止重复提交
            checkButton.disabled = true;
            checkButton.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i> 查询中...';
            
            try {
                // 构建查询URL
                const url = `https://api.kaka11.top/v1/dashboard/billing/subscription`;
                
                // 发送查询请求
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                // 处理响应
                if (response.ok) {
                    // 显示成功状态
                    loadingState.classList.add('hidden');
                    successState.classList.remove('hidden');
                     
                    // 更新时间戳
                    const now = new Date();
                    resultTimestamp.textContent = `查询时间: ${now.toLocaleString()}`;
                     
                    // 处理余额信息
                    let balanceDisplay;
                    if (data.system_hard_limit_usd === -1 || data.system_hard_limit_usd === undefined || data.system_hard_limit_usd === 100000000.0000) {
                        balanceDisplay = '无限额度';
                        tokenStatus.textContent = '有效 (无限额度)';
                        tokenStatus.className = 'font-medium text-secondary';
                    } else {
                        balanceDisplay = `${data.system_hard_limit_usd.toFixed(4)} 元`;
                        tokenStatus.textContent = '有效';
                        tokenStatus.className = 'font-medium text-secondary';
                    }
                     
                    balanceValue.textContent = balanceDisplay;
                      
                    // 余额低于1时显示充值提醒
                    if (data.system_hard_limit_usd !== -1 && data.system_hard_limit_usd !== undefined && data.system_hard_limit_usd !== 100000000.0000 && data.system_hard_limit_usd < 1) {
                        const rechargeAlert = document.createElement('div');
                        rechargeAlert.className = 'mt-3 p-3 bg-amber-50 border border-amber-200 rounded-lg flex items-start';
                        rechargeAlert.innerHTML = `
                            <i class="fa fa-exclamation-circle text-amber-500 mt-0.5 mr-2"></i>
                            <div>
                                <p class="text-sm font-medium text-amber-800">余额不足</p>
                                <p class="text-xs text-amber-700 mt-1">您的余额已低于1元，请及时充值以避免服务中断。</p>
                            </div>
                        `;
                        // 找到余额显示元素的父容器并添加提醒
                        balanceValue.parentElement.appendChild(rechargeAlert);
                    }
                      
                    // 处理待入账金额
                    if (data.pending_amount !== undefined && data.pending_amount > 0) {
                        pendingAmountContainer.classList.remove('hidden');
                        pendingAmount.textContent = `${data.pending_amount.toFixed(4)} 元`;
                    } else {
                        pendingAmountContainer.classList.add('hidden');
                    }
                } else if (response.status === 401) {
                    // 显示成功状态（但实际是401错误）
                    loadingState.classList.add('hidden');
                    successState.classList.remove('hidden');
                     
                    // 更新时间戳
                    const now = new Date();
                    resultTimestamp.textContent = `查询时间: ${now.toLocaleString()}`;
                     
                    // 处理401错误
                    balanceValue.textContent = '不可用';
                    pendingAmountContainer.classList.add('hidden');
                     
                    // 优先检查是否包含'不可用'相关文本（不区分大小写）
                    const message = String(data.message || '');
                    if (message.toLowerCase().includes('不可用')) {
                        tokenStatus.textContent = '已禁用';
                        tokenStatus.className = 'font-medium text-danger';
                    } else if (message.toLowerCase().includes('无效的令牌')) {
                        tokenStatus.textContent = '不存在';
                        tokenStatus.className = 'font-medium text-danger';
                    } else {
                        tokenStatus.textContent = '无效';
                        tokenStatus.className = 'font-medium text-danger';
                        errorMessage.textContent = message || '令牌无效或已过期';
                    }
                } else {
                    // 处理其他错误响应
                    throw new Error(data.message || `查询失败，状态码: ${response.status}`);
                }
            } catch (error) {
                // 显示错误状态
                loadingState.classList.add('hidden');
                errorState.classList.remove('hidden');
                errorMessage.textContent = error.message || '查询过程中发生未知错误';
            } finally {
                // 恢复按钮状态
                checkButton.disabled = false;
                checkButton.innerHTML = '<span>查询余额</span><i class="fa fa-arrow-right ml-2"></i>';
            }
        });

        // 重新查询按钮事件
        resetButton.addEventListener('click', () => {
            // 触发表单提交以重新查询
            balanceForm.dispatchEvent(new Event('submit'));
        });

        // 页面加载完成后聚焦到令牌输入框
        document.addEventListener('DOMContentLoaded', () => {
            tokenInput.focus();
        });
    </script>
</body>
</html>
